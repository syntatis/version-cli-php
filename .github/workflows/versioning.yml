name: Version Update

on:
  workflow_dispatch:
    inputs:
      part:
        type: choice
        description: "Select the version part to update"
        default: patch
        required: true
        options:
          - patch
          - minor
          - major

jobs:
  ci:
    name: CI
    if: ${{ github.ref_name == 'main' }}
    uses: ./.github/workflows/ci.yml
    secrets: inherit

  bump:
    needs: ci
    runs-on: ubuntu-latest
    name: Bump Version

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 7.4

      - name: Install PHP dependencies
        uses: ramsey/composer-install@v3

      - name: Get current version
        id: old
        run: |
          current_version=$(php -r "require 'vendor/autoload.php'; echo \Syntatis\Version\CLI\Commander::VERSION;")
          echo "Current version: $current_version"
          echo "version=$current_version" >> $GITHUB_OUTPUT

      - name: Increment version
        id: new
        run: |
          new_version=$(bin/version incr ${{ steps.old.outputs.version }} -p ${{ github.event.inputs.part }})
          echo "New version: $new_version"
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Update version in files
        run: |
          sed -i "s/const VERSION = '.*';/const VERSION = '${{ steps.new.outputs.version }}';/" app/Commander.php

      - name: Verify version update
        run: |
          update_version=$(php -r "require 'vendor/autoload.php'; echo \Syntatis\Version\CLI\Commander::VERSION;")

          if [ "$update_version" != "${{ steps.new.outputs.version }}" ]; then
            echo "Version update failed. Expected ${{ steps.new.outputs.version }}, but got $update_version"
            exit 1
          else
            echo "Version updated successfully from ${{ steps.old.outputs.version }} to $update_version"
          fi

      - name: Create a Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          branch-suffix: short-commit-hash
          commit-message: "Bump version to ${{ steps.new.outputs.version }}"
          branch: release/v${{ steps.new.outputs.version }}
          title: "Bump version to ${{ steps.new.outputs.version }}"
          add-paths: |
            app/*.php
          body: |
            This PR updates the version of the application from ${{ steps.old.outputs.version }} to ${{ steps.new.outputs.version }}.
            Please review the changes and merge if everything looks good.
          labels: |
            release
            help-wanted
